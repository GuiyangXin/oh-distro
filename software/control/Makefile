
# todo:
#   fix .matlabroot assumption below (this makefile will get confused if make has never been called in drake)
#   support debug mode (and pass it through properly to drake)

default_target: all

# get a list of subdirs to build by reading tobuild.txt
SUBDIRS:=$(shell grep -v "^\#" tobuild.txt)

# drake-related build variables
#PKG_CONFIG_PATH := ${PKG_CONFIG_PATH}:$(shell pwd)/drake/thirdParty

# NOTE:  this will fail if somebody has never run configure in drake, but the dependencies get more complicated
MATLABROOT = $(strip $(shell cat drake/.matlabroot))
MEX = $(MATLABROOT)/bin/mex
MEXEXT = $(shell $(MATLABROOT)/bin/mexext)
MATLABCPU = $(shell cat drake/.matlabcpu)

MAPS_FLAGS = $(subst -pthread,,$(shell pkg-config --cflags-only-I --libs maps eigen3 lcm opencv))
QP_FLAGS = $(subst -pthread,,$(shell export PKG_CONFIG_PATH=${PKG_CONFIG_PATH}:./drake/thirdParty/; pkg-config --cflags --libs eigen3 gurobi))
#BULLET_FLAGS = $(shell pkg-config --cflags --libs-only-L bullet) -DBULLET_COLLISION -lBulletCollision -lLinearMath
BULLET_FLAGS =
DEBUG = all


# Figure out where to build the software.
#   Use BUILD_PREFIX if it was passed in.
#   If not, search up to three parent directories for a 'build' directory.
#   Otherwise, use ./build.
ifeq "$(BUILD_PREFIX)" ""
BUILD_PREFIX=$(shell for pfx in ./ .. ../.. ../../..; do d=`pwd`/$$pfx/build; \
               if [ -d $$d ]; then echo $$d; exit 0; fi; done; echo `pwd`/build)
SRC_BUILD_PREFIX=$(shell for pfx in ./ .. ../.. ../../..; do d=`pwd`/src/../$$pfx/build; \
               if [ -d $$d ]; then echo $$d; exit 0; fi; done; echo `pwd`/build)
endif

.PHONY : drake

ifeq ($(MATLABCPU),maci64)
MEXFILES = $(BUILD_PREFIX)/matlab/QPControllermex.$(MEXEXT) \
	$(BUILD_PREFIX)/matlab/RobotStateMonitor.$(MEXEXT) \
	$(BUILD_PREFIX)/matlab/AtlasCommandPublisher.$(MEXEXT)
else
MEXFILES = $(BUILD_PREFIX)/matlab/QPControllermex.$(MEXEXT) \
	$(BUILD_PREFIX)/matlab/HeightMapWrapper.$(MEXEXT) \
	$(BUILD_PREFIX)/matlab/AtlasCommandPublisher.$(MEXEXT) \
	$(BUILD_PREFIX)/matlab/bot_timestamp_now.$(MEXEXT)
#	$(BUILD_PREFIX)/matlab/RobotStateMonitor.$(MEXEXT) \

endif

JAVAFILES := $(wildcard src/*.java)
CLASSFILES = $(JAVAFILES:%.java=%.class) 
SRCCLASSFILES = $(CLASSFILES:src/%=%)
CLASSPATH = $(PWD)/drake/drake.jar:/usr/local/share/java/lcm.jar:$(BUILD_PREFIX)/share/java/lcmtypes_drc_lcmtypes.jar:$(BUILD_PREFIX)/share/java/lcmtypes_bot2-core.jar:$(PWD)/src:$(PWD)/control/src
ifneq "$(WORKSPACE)" ""
   CLASSPATH := $(CLASSPATH):$(WORKSPACE)/drc/software/control/drake/drake.jar
endif

# build quietly by default.  For a verbose build, run "make VERBOSE=1"
$(VERBOSE).SILENT:

all: CXX += -O3
all: CC += -O3
all: MEX += -O
all: everything

debug: CXX += -g
debug: CC += -g
debug: MEX += -g
debug: DEBUG = debug
debug: everything


everything: drake $(BUILD_PREFIX)/config/drc_control_setup.m $(MEXFILES) $(BUILD_PREFIX)/share/java/drc_control.jar
	@[ -d $(BUILD_PREFIX) ] || mkdir -p $(BUILD_PREFIX) || exit 1
	@for subdir in $(SUBDIRS); do \
		echo "\n-------------------------------------------"; \
		echo "-- $$subdir"; \
		echo "-------------------------------------------"; \
		$(MAKE) -C $$subdir $(DEBUG) all || exit 2; \
	done
	@# Place additional commands here if you have any

java : $(BUILD_PREFIX)/share/java/drc_control.jar

$(BUILD_PREFIX)/share/java/drc_control.jar: $(CLASSFILES)
	cd src; \
	jar -cf $(SRC_BUILD_PREFIX)/share/java/drc_control.jar $(SRCCLASSFILES); \
	cd ..;

#.INTERMEDIATE : $(CLASSFILES)

%.class : %.java drake/drake.jar
	javac $< -cp $(CLASSPATH);

src/RobotPlanConstraintCheckedPublisher.class : src/RobotPlanPublisher.class

drake drake/drake.jar drake/systems/plants/RigidBodyManipulator.o drake/algorithms/fastQP.o :
	@echo "\n-------------------------------------------"; \
	echo "-- drake"; \
	echo "-------------------------------------------"; \
	$(MAKE) -C drake $(DEBUG) || exit 2;

$(BUILD_PREFIX)/config/drc_control_setup.m : write_drc_control_setup.m
	matlab -nosplash -nodesktop -r "setenv('BUILD_PREFIX','$(BUILD_PREFIX)'); write_drc_control_setup;exit";

ifeq ($(MATLABCPU),maci64)

$(BUILD_PREFIX)/matlab/QPControllermex.$(MEXEXT) : drake/systems/plants/RigidBodyManipulator.o drake/algorithms/fastQP.o src/QPControllermex.cpp
	$(MEX) src/QPControllermex.cpp \
		-outdir $(BUILD_PREFIX)/matlab \
		-largeArrayDims \
		-Idrake/systems/plants drake/systems/plants/RigidBodyManipulator.o \
		-Idrake/algorithms drake/algorithms/fastQP.o \
		$(QP_FLAGS)

else

$(BUILD_PREFIX)/matlab/HeightMapWrapper.$(MEXEXT) : src/HeightMapWrapper.cpp src/mexmaps/ViewClientWrapper.cpp src/mexmaps/FillMethods.cpp src/mexmaps/MapLib.cpp
	$(MEX) -v src/HeightMapWrapper.cpp src/mexmaps/ViewClientWrapper.cpp src/mexmaps/FillMethods.cpp src/mexmaps/MapLib.cpp \
		-outdir $(BUILD_PREFIX)/matlab \
		$(MAPS_FLAGS)

$(BUILD_PREFIX)/matlab/bot_timestamp_now.$(MEXEXT) : src/bot_timestamp_now.cpp
	$(MEX) -v src/bot_timestamp_now.cpp \
		-outdir $(BUILD_PREFIX)/matlab \
		$(MAPS_FLAGS)

$(BUILD_PREFIX)/matlab/QPControllermex.$(MEXEXT) : drake/systems/plants/RigidBodyManipulator.o drake/algorithms/fastQP.o src/QPControllermex.cpp src/mexmaps/ViewClientWrapper.cpp src/mexmaps/FillMethods.cpp src/mexmaps/MapLib.cpp
	$(MEX) src/QPControllermex.cpp src/mexmaps/ViewClientWrapper.cpp src/mexmaps/FillMethods.cpp src/mexmaps/MapLib.cpp \
		-outdir $(BUILD_PREFIX)/matlab \
		-largeArrayDims \
		-Idrake/systems/plants drake/systems/plants/RigidBodyManipulator.o \
		-Idrake/algorithms drake/algorithms/fastQP.o \
		-DUSE_MAPS $(MAPS_FLAGS) \
		$(BULLET_FLAGS) \
		$(QP_FLAGS)

endif

$(BUILD_PREFIX)/matlab/RobotStateMonitor.$(MEXEXT) : src/RobotStateMonitor.cpp
	$(MEX) src/RobotStateMonitor.cpp -outdir $(BUILD_PREFIX)/matlab -largeArrayDims $(subst -pthread,,$(shell pkg-config --cflags --libs lcm eigen3)) -I$(BUILD_PREFIX)/include

$(BUILD_PREFIX)/matlab/AtlasCommandPublisher.$(MEXEXT) : src/AtlasCommandPublisher.cpp
	$(MEX) src/AtlasCommandPublisher.cpp -outdir $(BUILD_PREFIX)/matlab -largeArrayDims $(subst -pthread,,$(shell pkg-config --cflags --libs lcm eigen3)) -I$(BUILD_PREFIX)/include

clean:
	-rm $(CLASSFILES)
	-rm $(BUILD_PREFIX)/share/java/drc_control.jar 	
	-rm $(MEXFILES)
	$(MAKE) -C drake clean;
	@for subdir in $(SUBDIRS); do \
		echo "\n-------------------------------------------"; \
		echo "-- $$subdir"; \
		echo "-------------------------------------------"; \
		$(MAKE) -C $$subdir clean; \
	done
	@# Place additional commands here if you have any


